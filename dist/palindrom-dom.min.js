/*! PalindromDOM, version: 6.4.0-0 */
!function(e,t,n){"use strict";t=t&&t.hasOwnProperty("default")?t.default:t,n=n&&n.hasOwnProperty("default")?n.default:n;var o="undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{};class r extends Error{constructor(e){super(e),this.message=e}}class i extends r{constructor(e,t,n,o){if(!t||!["Server","Client"].includes(t))throw new TypeError("Error constructing PalindromConnectionError, `side` parameter is required and can either be 'Server' or 'Client'");super(e),this.side=t,this.message=`${t} error\n\t${e.replace(/\n/g,"\n\t")}`,this.url=n,this.connectionType=o}}const s="Client";function a(e,t,n,o){let r,a;this.start=function(){r||(r=setTimeout(()=>{this.notifySend(),e()},n))},this.notifySend=function(){clearTimeout(r),r=null,a||(a=setTimeout(()=>{a=null,t(new i("Timeout has passed and response hasn't arrived",s,this.remoteUrl,"Unknown"))},o))},this.notifyReceive=function(){clearTimeout(a),a=null,this.start()},this.stop=()=>{clearTimeout(r),r=null,clearTimeout(a),a=null}}function h(){this.start=this.stop=this.notifySend=this.notifyReceive=()=>{}}const c="undefined"!=typeof globalThis&&globalThis||"undefined"!=typeof window&&window||void 0!==o&&o,l="Client",p="Server";function u(e){return e.replace(/^http/i,"ws")}class d{constructor(e,t,n,o,r,i,s,c,l){if(this.palindrom=e,"undefined"!=typeof window&&window.location?this.remoteUrl=new URL(t,window.location.href):this.remoteUrl=new URL(t),o&&(this.onReceive=o),r&&(this.onSend=r),i&&(this.onConnectionError=i),c&&(this.onStateChange=c),s&&(this.onSocketOpened=s),Object.defineProperty(this,"useWebSocket",{get:function(){return n},set:e=>(n=e,0==e?this._ws&&(this._ws.onclose=function(){this._ws=null},this._ws.close()):this.wsUrl||(this.wsUrl=u(this.remoteUrl.href)),n)}),l){const e=1e3*l;this.heartbeat=new a(()=>{this.send([])},this._handleConnectionError.bind(this),e,e)}else this.heartbeat=new h}async _establish(e=null){this.heartbeat.stop();const t=e?await this._fetch("PATCH",this.remoteUrl.href+"/reconnect","application/json",JSON.stringify(e)):await this._fetch("GET",this.remoteUrl.href,"application/json",null);return this.useWebSocket&&this.webSocketUpgrade(this.onSocketOpened),this.heartbeat.start(),t}_handleConnectionError(e){this.heartbeat.stop(),this.palindrom.reconnector.triggerReconnection(),this.onConnectionError(e)}_handleFatalError(e){this.heartbeat.stop(),this.palindrom.reconnector.stopReconnecting(),this.onConnectionError(e)}_notifyReceive(){this.heartbeat.notifyReceive(),this.onReceive(...arguments)}async send(e){this.heartbeat.notifySend();const t=JSON.stringify(e);if(this.useWebSocket&&this._ws&&1===this._ws.readyState)this._ws.send(t),this.onSend(t,this._ws.url,"WS");else{const e=this.remoteUrl.href,n="PATCH",o=await this._fetch(n,e,"application/json-patch+json",t);this._notifyReceive(o,e,n)}return this}onReceive(){}onSend(){}onStateChange(){}upgrade(e){}webSocketUpgrade(e){this.wsUrl=u(this.remoteUrl.href);const t=this.wsUrl;this.closeConnection();let o=c.WebSocket||n;o=o.w3cwebsocket||o,this._ws=new o(t),this._ws.onopen=n=>{this.onStateChange(this._ws.readyState,t),e&&e(n)},this._ws.onmessage=e=>{try{var t=JSON.parse(e.data)}catch(t){return void this._handleFatalError(new i(e.data,p,this._ws.url,"WS"))}this._notifyReceive(t,this._ws.url,"WS")},this._ws.onerror=e=>{if(this.onStateChange(this._ws.readyState,t,e.data),!this.useWebSocket)return;const n=["WebSocket connection could not be made","readyState: "+this._ws.readyState].join("\n");this._handleFatalError(new i(n,l,t,"WS"))},this._ws.onclose=e=>{this.onStateChange(this._ws.readyState,t,null,e.code,e.reason);const n=["WebSocket connection closed unexpectedly.","reason: "+e.reason,"readyState: "+this._ws.readyState,"stateCode: "+e.code].join("\n");e.reason?this._handleFatalError(new i(n,p,t,"WS")):e.wasClean||this._handleConnectionError(new i(n,p,t,"WS"))}}closeConnection(){this._ws&&(this._ws.onclose=()=>{},this._ws.close(),this._ws=null)}stop(){this.closeConnection(),this.heartbeat.stop(),this.heartbeat=new h}async getPatchUsingHTTP(e){const t=await this._fetch("GET",e,"application/json-patch+json",null,!0);return this._notifyReceive(t,e,"GET"),t}_setRemoteUrl(e){if(this.remoteUrlSet&&this.remoteUrl&&this.remoteUrl!=e){const t=["Session lost.","Server replied with a different session ID than the already set one.","Possibly a server restart happened while you were working.","Please reload the page.","Previous session ID: "+this.remoteUrl,"New session ID: "+e].join("\n");throw new r(t)}this.remoteUrlSet=!0,this.remoteUrl=new URL(e,this.remoteUrl.href)}_handleLocationHeader(e){const t=e.headers.get("x-location")||e.headers.get("location");t&&this._setRemoteUrl(t)}async _handleFailureResponse(e,t,n){var o=`An unknown network error has occurred. Raw message: ${n.message}`;console.error(n);const r=[o,"statusCode: -1","reason: Maybe you lost connection with the server","url: "+e,"HTTP method: "+t].join("\n");this._handleFatalError(new i(r,l,e,t))}async _fetch(e,n,o,r,i){const s={headers:{},method:e,credentials:"include"},a=s.headers;r&&(a["Content-Type"]="application/json-patch+json",s.body=r),o&&(a.Accept=o),this.remoteUrl&&i&&(a["X-Referer"]=this.remoteUrl.pathname),this.onSend(r,n,e);const h=c.fetch||t,l=await h(n,s);return l.json().then(e=>{if(l.status<500)return this._handleLocationHeader(l),e;throw new Error(`HTTP ${l.status} response: response body is ${JSON.stringify(e)}`)}).catch(t=>{throw this._handleFailureResponse(n,e,t),t})}}
/*!
             * https://github.com/Starcounter-Jack/JSON-Patch
             * (c) 2017 Joachim Wester
             * MIT license
             */var f,w=(f=function(e,t){return(f=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},function(e,t){function n(){this.constructor=e}f(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),v=Object.prototype.hasOwnProperty;function y(e,t){return v.call(e,t)}function m(e){if(Array.isArray(e)){for(var t=new Array(e.length),n=0;n<t.length;n++)t[n]=""+n;return t}if(Object.keys)return Object.keys(e);t=[];for(var o in e)y(e,o)&&t.push(o);return t}function g(e){switch(typeof e){case"object":return JSON.parse(JSON.stringify(e));case"undefined":return null;default:return e}}function b(e){for(var t,n=0,o=e.length;n<o;){if(!((t=e.charCodeAt(n))>=48&&t<=57))return!1;n++}return!0}function _(e){return-1===e.indexOf("/")&&-1===e.indexOf("~")?e:e.replace(/~/g,"~0").replace(/\//g,"~1")}function E(e){return e.replace(/~1/g,"/").replace(/~0/g,"~")}function P(e,t){var n=[e];for(var o in t){var r="object"==typeof t[o]?JSON.stringify(t[o],null,2):t[o];void 0!==r&&n.push(o+": "+r)}return n.join("\n")}var O=function(e){function t(t,n,o,r,i){var s=this.constructor,a=e.call(this,P(t,{name:n,index:o,operation:r,tree:i}))||this;return a.name=n,a.index=o,a.operation=r,a.tree=i,Object.setPrototypeOf(a,s.prototype),a.message=P(t,{name:n,index:o,operation:r,tree:i}),a}return w(t,e),t}(Error),T=O,S=g,A={add:function(e,t,n){return e[t]=this.value,{newDocument:n}},remove:function(e,t,n){var o=e[t];return delete e[t],{newDocument:n,removed:o}},replace:function(e,t,n){var o=e[t];return e[t]=this.value,{newDocument:n,removed:o}},move:function(e,t,n){var o=j(n,this.path);o&&(o=g(o));var r=k(n,{op:"remove",path:this.from}).removed;return k(n,{op:"add",path:this.path,value:r}),{newDocument:n,removed:o}},copy:function(e,t,n){var o=j(n,this.from);return k(n,{op:"add",path:this.path,value:g(o)}),{newDocument:n}},test:function(e,t,n){return{newDocument:n,test:x(e[t],this.value)}},_get:function(e,t,n){return this.value=e[t],{newDocument:n}}},R={add:function(e,t,n){return b(t)?e.splice(t,0,this.value):e[t]=this.value,{newDocument:n,index:t}},remove:function(e,t,n){return{newDocument:n,removed:e.splice(t,1)[0]}},replace:function(e,t,n){var o=e[t];return e[t]=this.value,{newDocument:n,removed:o}},move:A.move,copy:A.copy,test:A.test,_get:A._get};function j(e,t){if(""==t)return e;var n={op:"_get",path:t};return k(e,n),n.value}function k(e,t,n,o,r,i){if(void 0===n&&(n=!1),void 0===o&&(o=!0),void 0===r&&(r=!0),void 0===i&&(i=0),n&&("function"==typeof n?n(t,0,e,t.path):C(t,0)),""===t.path){var s={newDocument:e};if("add"===t.op)return s.newDocument=t.value,s;if("replace"===t.op)return s.newDocument=t.value,s.removed=e,s;if("move"===t.op||"copy"===t.op)return s.newDocument=j(e,t.from),"move"===t.op&&(s.removed=e),s;if("test"===t.op){if(s.test=x(e,t.value),!1===s.test)throw new T("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return s.newDocument=e,s}if("remove"===t.op)return s.removed=e,s.newDocument=null,s;if("_get"===t.op)return t.value=e,s;if(n)throw new T("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",i,t,e);return s}o||(e=g(e));var a=(t.path||"").split("/"),h=e,c=1,l=a.length,p=void 0,u=void 0,d=void 0;for(d="function"==typeof n?n:C;;){if(u=a[c],r&&"__proto__"==u)throw new TypeError("JSON-Patch: modifying `__proto__` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(n&&void 0===p&&(void 0===h[u]?p=a.slice(0,c).join("/"):c==l-1&&(p=t.path),void 0!==p&&d(t,0,e,p)),c++,Array.isArray(h)){if("-"===u)u=h.length;else{if(n&&!b(u))throw new T("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",i,t,e);b(u)&&(u=~~u)}if(c>=l){if(n&&"add"===t.op&&u>h.length)throw new T("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",i,t,e);if(!1===(s=R[t.op].call(t,h,u,e)).test)throw new T("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return s}}else if(u&&-1!=u.indexOf("~")&&(u=E(u)),c>=l){if(!1===(s=A[t.op].call(t,h,u,e)).test)throw new T("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return s}h=h[u]}}function N(e,t,n,o,r){if(void 0===o&&(o=!0),void 0===r&&(r=!0),n&&!Array.isArray(t))throw new T("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");o||(e=g(e));for(var i=new Array(t.length),s=0,a=t.length;s<a;s++)i[s]=k(e,t[s],n,!0,r,s),e=i[s].newDocument;return i.newDocument=e,i}function C(e,t,n,o){if("object"!=typeof e||null===e||Array.isArray(e))throw new T("Operation is not an object","OPERATION_NOT_AN_OBJECT",t,e,n);if(!A[e.op])throw new T("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",t,e,n);if("string"!=typeof e.path)throw new T("Operation `path` property is not a string","OPERATION_PATH_INVALID",t,e,n);if(0!==e.path.indexOf("/")&&e.path.length>0)throw new T('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",t,e,n);if(("move"===e.op||"copy"===e.op)&&"string"!=typeof e.from)throw new T("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",t,e,n);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&void 0===e.value)throw new T("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",t,e,n);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&function e(t){if(void 0===t)return!0;if(t)if(Array.isArray(t)){for(var n=0,o=t.length;n<o;n++)if(e(t[n]))return!0}else if("object"==typeof t){var r=m(t),i=r.length;for(n=0;n<i;n++)if(e(t[r[n]]))return!0}return!1}(e.value))throw new T("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",t,e,n);if(n)if("add"==e.op){var r=e.path.split("/").length,i=o.split("/").length;if(r!==i+1&&r!==i)throw new T("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",t,e,n)}else if("replace"===e.op||"remove"===e.op||"_get"===e.op){if(e.path!==o)throw new T("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",t,e,n)}else if("move"===e.op||"copy"===e.op){var s=U([{op:"_get",path:e.from,value:void 0}],n);if(s&&"OPERATION_PATH_UNRESOLVABLE"===s.name)throw new T("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",t,e,n)}}function U(e,t,n){try{if(!Array.isArray(e))throw new T("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(t)N(g(t),g(e),n||!0);else{n=n||C;for(var o=0;o<e.length;o++)n(e[o],o,t,void 0)}}catch(e){if(e instanceof T)return e;throw e}}function x(e,t){if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t){var n,o,r,i=Array.isArray(e),s=Array.isArray(t);if(i&&s){if((o=e.length)!=t.length)return!1;for(n=o;0!=n--;)if(!x(e[n],t[n]))return!1;return!0}if(i!=s)return!1;var a=Object.keys(e);if((o=a.length)!==Object.keys(t).length)return!1;for(n=o;0!=n--;)if(!t.hasOwnProperty(a[n]))return!1;for(n=o;0!=n--;)if(!x(e[r=a[n]],t[r]))return!1;return!0}return e!=e&&t!=t}var L=Object.freeze({__proto__:null,JsonPatchError:T,deepClone:S,getValueByPointer:j,applyOperation:k,applyPatch:N,applyReducer:function(e,t,n){var o=k(e,t);if(!1===o.test)throw new T("Test operation failed","TEST_OPERATION_FAILED",n,t,e);return o.newDocument},validator:C,validate:U,_areEquals:x}),I=new WeakMap,M=function(e){this.observers=new Map,this.obj=e},D=function(e,t){this.callback=e,this.observer=t};
/*!
             * https://github.com/Starcounter-Jack/JSON-Patch
             * (c) 2017 Joachim Wester
             * MIT license
             */function V(e,t){void 0===t&&(t=!1);var n=I.get(e.object);H(n.value,e.object,e.patches,"",t),e.patches.length&&N(n.value,e.patches);var o=e.patches;return o.length>0&&(e.patches=[],e.callback&&e.callback(o)),o}function H(e,t,n,o,r){if(t!==e){"function"==typeof t.toJSON&&(t=t.toJSON());for(var i=m(t),s=m(e),a=!1,h=s.length-1;h>=0;h--){var c=e[p=s[h]];if(!y(t,p)||void 0===t[p]&&void 0!==c&&!1===Array.isArray(t))Array.isArray(e)===Array.isArray(t)?(r&&n.push({op:"test",path:o+"/"+_(p),value:g(c)}),n.push({op:"remove",path:o+"/"+_(p)}),a=!0):(r&&n.push({op:"test",path:o,value:e}),n.push({op:"replace",path:o,value:t}));else{var l=t[p];"object"==typeof c&&null!=c&&"object"==typeof l&&null!=l?H(c,l,n,o+"/"+_(p),r):c!==l&&(r&&n.push({op:"test",path:o+"/"+_(p),value:g(c)}),n.push({op:"replace",path:o+"/"+_(p),value:g(l)}))}}if(a||i.length!=s.length)for(h=0;h<i.length;h++){var p;y(e,p=i[h])||void 0===t[p]||n.push({op:"add",path:o+"/"+_(p),value:g(t[p])})}}}var J=Object.freeze({__proto__:null,unobserve:function(e,t){t.unobserve()},observe:function(e,t){var n,o=function(e){return I.get(e)}(e);if(o){var r=function(e,t){return e.observers.get(t)}(o,t);n=r&&r.observer}else o=new M(e),I.set(e,o);if(n)return n;if(n={},o.value=g(e),t){n.callback=t,n.next=null;var i=function(){V(n)},s=function(){clearTimeout(n.next),n.next=setTimeout(i)};"undefined"!=typeof window&&(window.addEventListener("mouseup",s),window.addEventListener("keyup",s),window.addEventListener("mousedown",s),window.addEventListener("keydown",s),window.addEventListener("change",s))}return n.patches=[],n.object=e,n.unobserve=function(){V(n),clearTimeout(n.next),function(e,t){e.observers.delete(t.callback)}(o,n),"undefined"!=typeof window&&(window.removeEventListener("mouseup",s),window.removeEventListener("keyup",s),window.removeEventListener("mousedown",s),window.removeEventListener("keydown",s),window.removeEventListener("change",s))},o.observers.set(t,new D(t,n)),n},generate:V,compare:function(e,t,n){void 0===n&&(n=!1);var o=[];return H(e,t,o,"",n),o}});Object.assign({},L,J,{JsonPatchError:O,deepClone:g,escapePathComponent:_,unescapePathComponent:E});
/*!
             * https://github.com/Palindrom/JSONPatcherProxy
             * (c) 2017 Starcounter
             * MIT license
             *
             * Vocabulary used in this file:
             *  * root - root object that is deeply observed by JSONPatcherProxy
             *  * tree - any subtree within the root or the root
             */
const q=function(){function e(e){return-1==e.indexOf("/")&&-1==e.indexOf("~")?e:e.replace(/~/g,"~0").replace(/\//g,"~1")}function t(e,t){const n=[];let o=e._parenthoodMap.get(t);for(;o&&o.key;)n.unshift(o.key),o=e._parenthoodMap.get(o.parent);if(n.length){return"/"+n.join("/")}return""}function n(e,t,n){return n?function(e,t){void 0===e&&(e=null);void 0===t&&(t=null);return e!==t}(e,t):function(e,t){return e!==t}(e,t)}function o(e,t){this._isProxifyingTreeNow=!1,this._isObserving=!1,this._treeMetadataMap=new Map,this._parenthoodMap=new Map,"boolean"!=typeof t&&(t=!0),this._showDetachedWarning=t,this._originalRoot=e,this._cachedProxy=null,this._isRecording=!1,this._userCallback,this._defaultCallback,this._patches}return o.deepClone=function(e){switch(typeof e){case"object":return JSON.parse(JSON.stringify(e));case"undefined":return null;default:return e}},o.escapePathComponent=e,o.prototype._generateProxyAtKey=function(o,r,i){if(!r)return r;const s={set:(...o)=>(function o(r,i,s,a){const h=t(r,i)+"/"+e(s),c=r._treeMetadataMap.get(a);r._treeMetadataMap.has(a)&&r._parenthoodMap.set(c.originalObject,{parent:i,key:s}),c&&!r._isProxifyingTreeNow&&(c.inherited=!0);let l=!1;const p=Array.isArray(i),u=p&&!Number.isInteger(+s.toString());a&&"object"==typeof a&&!r._treeMetadataMap.has(a)&&(u?(console.warn(`JSONPatcherProxy noticed a non-integer property ('${s}') was set for an array. This interception will not emit a patch. The value is an object, but it was not proxified, because it would not be addressable in JSON-Pointer`),l=!0):(r._parenthoodMap.set(a,{parent:i,key:s}),a=r._proxifyTreeRecursively(i,a,s)));const d=i[s],f=i.hasOwnProperty(s);if(p&&!u){const e=parseInt(s,10);e>i.length&&o(r,i,e-1+"",void 0)}const w=Reflect.set(i,s,a),v={op:"remove",path:h};if(void 0===a){if(!p&&!f)return w;{if(f&&!n(d,a,p))return w;p&&(v.value=null,v.op=f?"replace":"add");const e=r._treeMetadataMap.get(d);e&&(r._parenthoodMap.delete(d),r._disableTrapsForTreeMetadata(e),r._treeMetadataMap.delete(e))}}else{if(u)return"length"==s||l||console.warn(`JSONPatcherProxy noticed a non-integer property ('${s}') was set for an array. This interception will not emit a patch`),w;if(v.op="add",f&&(void 0!==d||p)){if(!n(d,a,p))return w;v.op="replace"}v.value=a}return r._defaultCallback(v),w})(this,...o),deleteProperty:(...n)=>(function(n,o,r){const i=o[r],s=Reflect.deleteProperty(o,r);if(void 0!==i){const s=t(n,o)+"/"+e(r),a=n._treeMetadataMap.get(i);a&&(a.inherited?a.inherited=!1:(n._parenthoodMap.delete(a.originalObject),n._disableTrapsForTreeMetadata(a),n._treeMetadataMap.delete(i))),n._defaultCallback({op:"remove",path:s})}return s})(this,...n)},a=Proxy.revocable(r,s);return a.handler=s,a.originalObject=r,this._parenthoodMap.set(r,{parent:o,key:i}),this._treeMetadataMap.set(a.proxy,a),a.proxy},o.prototype._proxifyTreeRecursively=function(t,n,o){for(let t in n)n.hasOwnProperty(t)&&n[t]instanceof Object&&(n[t]=this._proxifyTreeRecursively(n,n[t],e(t)));return this._generateProxyAtKey(t,n,o)},o.prototype._proxifyRoot=function(e){this.pause(),this._isProxifyingTreeNow=!0;const t=this._proxifyTreeRecursively(void 0,e,"");return this._isProxifyingTreeNow=!1,this.resume(),t},o.prototype._disableTrapsForTreeMetadata=function(e){if(this._showDetachedWarning){const t="You're accessing an object that is detached from the observedObject tree, see https://github.com/Palindrom/JSONPatcherProxy#detached-objects";e.handler.set=(e,n,o)=>(console.warn(t),Reflect.set(e,n,o)),e.handler.set=(e,n,o)=>(console.warn(t),Reflect.set(e,n,o)),e.handler.deleteProperty=(e,t)=>Reflect.deleteProperty(e,t)}else delete e.handler.set,delete e.handler.get,delete e.handler.deleteProperty},o.prototype.observe=function(e,t){if(!e&&!t)throw new Error("You need to either record changes or pass a callback");return this._isRecording=e,this._userCallback=t,e&&(this._patches=[]),this._cachedProxy=this._proxifyRoot(this._originalRoot),this._cachedProxy},o.prototype.generate=function(){if(!this._isRecording)throw new Error("You should set record to true to get patches later");return this._patches.splice(0,this._patches.length)},o.prototype.revoke=function(){this._treeMetadataMap.forEach(e=>{e.revoke()})},o.prototype.disableTraps=function(){this._treeMetadataMap.forEach(this._disableTrapsForTreeMetadata,this)},o.prototype.resume=function(){this._defaultCallback=e=>{this._isRecording&&this._patches.push(e),this._userCallback&&this._userCallback(e)},this._isObserving=!0},o.prototype.pause=function(){this._defaultCallback=()=>{},this._isObserving=!1},o}(),W=function(e,t,n,o){this.obj=e,this.waiting=[],this.localPath=t[0],this.remotePath=t[1],this.apply=n,this.purist=o};W.prototype.localVersion=0,W.prototype.remoteVersion=0,W.prototype.receive=function(e,t){const n=t||this.apply;let o=e.slice(0);this.purist&&o.shift();const r=o.shift().value;if(r<=this.remoteVersion)throw new Error("Given version was already applied.");if(r==this.remoteVersion+1)for(;o;)this.remoteVersion++,this.obj=n(this.obj,o),o=this.waiting.shift();else this.waiting[r-this.remoteVersion-2]=o},W.prototype.send=function(e){this.localVersion++;const t=e.slice(0);return this.purist?t.unshift({op:"test",path:this.localPath,value:this.localVersion-1},{op:"replace",path:this.localPath,value:this.localVersion}):t.unshift({op:"replace",path:this.localPath,value:this.localVersion}),t},W.getPropertyByJsonPointer=function(e,t){const n=t.split("/");""===n[0]&&n.shift();let o,r=e;for(;n.length;)o=n.shift().replace("~1","/").replace("~0","~"),n.length&&(r=r[o]);return r[o]},W.prototype.reset=function(e){this.remoteVersion=W.getPropertyByJsonPointer(e,this.remotePath),this.waiting=[];const t=[{op:"replace",path:"",value:e}];return this.obj=this.apply(this.obj,t)};
/*!
             * https://github.com/Palindrom/JSONPatchOT
             * JSON-Patch-OT version: 3.0.0-0
             * (c) 2017 Tomek Wytrebowicz
             * MIT license
             */
var F=function(){var e=e||{};e.transform=function(e,n){var o=[];o=o.concat.apply(o,n);var r=JSON.parse(JSON.stringify(e));return o.reduce(t,r)},e.transformAgainstSingleOp=function(e,t){};var t=function(e,t){if(void 0===t.value&&("add"===t.op||"replace"===t.op||"test"===t.op))throw new Error("'value' MUST be defined");if(void 0===t.from&&("copy"===t.op||"move"===t.op))throw new Error("'from' MUST be defined");if(n[t.op])if("function"==typeof n[t.op])n[t.op](t,e);else for(var o=e.length,r=0;r<o;){var i=e[r];r++,n[t.op][i.op]&&n[t.op][i.op](t,i)}return e},n={remove:function(e,t){for(var n,i=t.length,s=0;n=t[s];)("add"!==n.op&&"test"!==n.op||e.path!==n.path)&&(n.from&&(n.from===e.path||0===n.from.indexOf(e.path+"/"))||e.path===n.path||0===n.path.indexOf(e.path+"/"))&&(t.splice(s,1),i--,s--),s++;var a=e.path.lastIndexOf("/");if(a>-1){var h=e.path.substr(a+1),c=e.path.substr(0,a+1);if(r(h))for(i=t.length,s=0;s<i;)n=t[s],s++,0===n.path.indexOf(c)&&(n.path=o(n.path,c,h)),n.from&&0===n.from.indexOf(c)&&(n.from=o(n.from,c,h))}},replace:function(e,t){for(var n,o=0;n=t[o];)(n.from&&(n.from===e.path||0===n.from.indexOf(e.path+"/"))||0===n.path.indexOf(e.path+"/"))&&(t.splice(o,1),o--),o++}};function o(e,t,n){var o=e.substr(t.length),i=o.indexOf("/");i>-1||(i=o.length);var s=o.substr(0,i),a=o.substr(i);return r(s)&&s>n?t+(s-1)+a:e}function r(e){var t=~~Number(e);return String(t)===e&&t>=0}return e}(),$=function(e,t,n,o,r){W.call(this,e,n,o,r),this.transform=t,this.pending=[]};function B(e,t,n){let o,r,i,s;const a=1e3;function h(){o=a,r=0,i=!1,clearTimeout(s),s=null}const c=()=>{0==r?(t(0),i=!1,o*=2,e()):(t(r),r-=1e3,s=setTimeout(c,1e3))};this.triggerReconnection=()=>{i||(r=o,i=!0,c())},this.reconnectNow=()=>{r=0,o=a},this.stopReconnecting=()=>{h(),n()},h()}$.prototype=Object.create(W.prototype),$.prototype.constructor=$,$.prototype.ackLocalVersion=0,$.prototype.send=function(e){var t=e.slice(0);t.unshift({op:"test",path:this.remotePath,value:this.remoteVersion});var n=W.prototype.send.call(this,t);return this.pending.push(n),n},$.prototype.receive=function(e,t){var n=t||this.apply,o=this;return W.prototype.receive.call(this,e,(function(e,t){var r=t.slice(0),i=r.shift().value,s=i-o.ackLocalVersion;return o.ackLocalVersion=i,o.pending.splice(0,s),o.pending.length&&(r=o.transform(r,o.pending)),o.obj=n(o.obj,r)}))},$.prototype.reset=function(e){return this.ackLocalVersion=W.getPropertyByJsonPointer(e,this.localPath),this.pending=[],this.obj=W.prototype.reset.call(this,e)};class G{constructor(e,t){this.obj=e,this.apply=t}send(e){return e}receive(e){return this.obj=this.apply(this.obj,e)}reset(e){const t=[{op:"replace",path:"",value:e}];return this.obj=this.apply(this.obj,t)}}
/*! Palindrom
             * https://github.com/Palindrom/Palindrom
             * (c) 2017 Joachim Wester
             * MIT license
             */const Y="6.4.0-0";class X{static get version(){return Y}constructor(e){if(this.version=Y,"object"!=typeof e)throw new TypeError("Palindrom constructor requires an object argument.");if(!e.remoteUrl)throw new TypeError("remoteUrl is required");function t(){}e.callback&&console.warn("options.callback is deprecated. Please use `onStateReset` instead"),this.debug=null==e.debug||e.debug,this.isObserving=!1,this.onLocalChange=e.onLocalChange||t,this.onRemoteChange=e.onRemoteChange||t,this.onStateReset=e.onStateReset||e.callback||t,this.filterLocalChange=e.filterLocalChange||(e=>e),this.onPatchReceived=e.onPatchReceived||t,this.onPatchSent=e.onPatchSent||t,this.onSocketStateChanged=e.onSocketStateChanged||t,this.onConnectionError=e.onConnectionError||t,this.retransmissionThreshold=e.retransmissionThreshold||3,this.onReconnectionCountdown=e.onReconnectionCountdown||t,this.onReconnectionEnd=e.onReconnectionEnd||t,this.onSocketOpened=e.onSocketOpened||t,this.onIncomingPatchValidationError=e.onIncomingPatchValidationError||t,this.onOutgoingPatchValidationError=e.onOutgoingPatchValidationError||t,this.onError=e.onError||t,this.reconnector=new B(()=>this._connectToRemote(this.queue.pending),this.onReconnectionCountdown,this.onReconnectionEnd),this.network=new d(this,e.remoteUrl,e.useWebSocket||!1,this.handleRemoteChange.bind(this),this.onPatchSent.bind(this),this.onConnectionError.bind(this),this.onSocketOpened.bind(this),this.onSocketStateChanged.bind(this),e.pingIntervalS),this.OTPatchIndexOffset=0,e.localVersionPath&&e.remoteVersionPath?(this.OTPatchIndexOffset=2,e.ot?this.queue=new $(this.obj,F.transform,[e.localVersionPath,e.remoteVersionPath],this.validateAndApplySequence.bind(this),e.purity):this.queue=new W(this.obj,[e.localVersionPath,e.remoteVersionPath],this.validateAndApplySequence.bind(this),e.purity)):this.queue=new G(this.obj,this.validateAndApplySequence.bind(this)),this._connectToRemote()}async _connectToRemote(e=null){const t=await this.network._establish(e);this.reconnector.stopReconnecting(),this.debug&&(this.remoteObj=JSON.parse(JSON.stringify(t))),this.queue.reset(t)}get useWebSocket(){return this.network.useWebSocket}set useWebSocket(e){this.network.useWebSocket=e}_sendPatch(e){this.unobserve(),this.network.send(e),this.observe()}prepareProxifiedObject(e){e||(e={}),this.jsonPatcherProxy=new q(e);const t=this.jsonPatcherProxy.observe(!1,e=>{const t=this.filterLocalChange(e);t&&this.handleLocalChange(t)});Object.defineProperty(this,"obj",{get:()=>t,set(){throw new Error("palindrom.obj is readonly")},configurable:!0}),this.isObserving=!0}observe(){this.jsonPatcherProxy&&this.jsonPatcherProxy.resume(),this.isObserving=!0}unobserve(){this.jsonPatcherProxy&&this.jsonPatcherProxy.pause(),this.isObserving=!1}handleLocalChange(e){const t=[e];this.debug&&this.validateSequence(this.remoteObj,t),this._sendPatch(this.queue.send(t)),this.onLocalChange(t)}validateAndApplySequence(e,t){try{this.unobserve();const n=N(e,t,this.debug);if(this.observe(),n.newDocument!==e){this.prepareProxifiedObject(n.newDocument),this.queue.obj=this.obj,K(this.obj,this.onIncomingPatchValidationError);try{this.onStateReset(this.obj)}catch(e){this.onError(new r(`Error inside onStateReset callback: ${e.message}`)),console.error(e)}}this.onRemoteChange(t,n)}catch(e){if(this.debug)return void this.onIncomingPatchValidationError(e);throw e}return this.obj}validateSequence(e,t){const n=U(t,e);n&&this.onOutgoingPatchValidationError(n)}reconnectNow(){this.reconnector.reconnectNow()}handleRemoteChange(e,t,n){this.onPatchReceived(e,t,n);const o=e||[];!function(e,t,n){for(let o=n,r=e.length;o<r;o++)K(e[o].value,t,e[o].path)}(o,this.onIncomingPatchValidationError,this.OTPatchIndexOffset),0!==o.length&&this.isObserving&&(this.queue.receive(o),this.queue.pending&&this.queue.pending.length&&this.queue.pending.length>this.retransmissionThreshold&&this.queue.pending.forEach(this._sendPatch,this),this.debug&&(this.remoteObj=JSON.parse(JSON.stringify(this.obj))))}stop(){this.unobserve(),this.reconnector.stopReconnecting(),this.network.stop()}}function K(e,t,n=""){const o=typeof e;if("object"==o)for(const o in e)e.hasOwnProperty(o)&&K(e[o],t,n+"/"+o);else"number"===o&&(e>Number.MAX_SAFE_INTEGER||e<Number.MIN_SAFE_INTEGER)&&t(new RangeError(`A number that is either bigger than Number.MAX_INTEGER_VALUE or smaller than Number.MIN_INTEGER_VALUE has been encountered in a patch, value is: ${e}, variable path is: ${n}`))}
/*! Palindrom
             * https://github.com/Palindrom/Palindrom
             * (c) 2017 Joachim Wester
             * MIT license
             */class Q extends Error{}async function z(e){return new Promise(t=>{setTimeout(t,e)})}class Z extends X{constructor(e){if("object"!=typeof e)throw new Error("PalindromDOM constructor requires an object argument.");if(!e.remoteUrl)throw new Error("remoteUrl is required");const t=e.onStateReset||e.callback;e.callback&&console.warn("Palindrom: options.callback is deprecated. Please use `onStateReset` instead"),e.onStateReset=function(e){this.listen(),t&&t.call(this,e)},super(e),this.element=e.listenTo||document,this.clickHandler=this.clickHandler.bind(this),this.historyHandler=this.historyHandler.bind(this),this.morphUrlEventHandler=this.morphUrlEventHandler.bind(this),this._scrollWatcher=this._scrollWatcher.bind(this),this.element.addEventListener("palindrom-redirect-pushstate",this.morphUrlEventHandler),"scrollRestoration"in history&&(history.scrollRestoration="manual")}listen(){this.listening=!0,this.element.addEventListener("click",this.clickHandler),window.addEventListener("popstate",this.historyHandler),this.element.addEventListener("palindrom-morph-url",this.morphUrlEventHandler),this.element.addEventListener("palindrom-redirect-pushstate",this.morphUrlEventHandler),this._watchingScroll()}_watchingScroll(){window.addEventListener("scroll",this._scrollWatcher)}_unwatchingScroll(){window.removeEventListener("scroll",this._scrollWatcher)}_scrollWatcher(){this._attemptingScroll||(clearTimeout(this._scrollDebounceTimeout),this._scrollDebounceTimeout=setTimeout(()=>{history.replaceState([window.scrollX,window.scrollY],null)},20))}unlisten(){this.listening=!1,this.element.removeEventListener("click",this.clickHandler),window.removeEventListener("popstate",this.historyHandler),this.element.removeEventListener("palindrom-redirect-pushstate",this.morphUrlEventHandler),this.element.removeEventListener("palindrom-morph-url",this.morphUrlEventHandler),this._unwatchingScroll()}async getPatchUsingHTTP(e){const t=new CustomEvent("palindrom-before-redirect",{detail:{href:e},cancelable:!0,bubbles:!0});if(this.element.dispatchEvent(t),t.defaultPrevented)throw new Q("`getPatchUsingHTTP` was aborted by cancelling `palindrom-before-redirect` event.");const n=await this.network.getPatchUsingHTTP(e);const o=new CustomEvent("palindrom-after-redirect",{detail:{href:e,data:n},bubbles:!0});return this.element.dispatchEvent(o),n}async morphUrl(e){const t=window.scrollX,n=window.scrollY;try{if(await this.getPatchUsingHTTP(e))return history.replaceState([t,n],null,window.location.href),history.pushState([0,0],null,e),scrollTo(0,0),!0}catch(e){if(e instanceof Q)return!1;throw new Error(`HTTP request failed, error message: ${e.message}`)}}morphUrlEventHandler(e){return this.morphUrl(e.detail.url)}clickHandler(e){if(e.ctrlKey||e.metaKey||2==e.which)return;e.detail&&e.detail.target&&(e=e.detail);let t=e.target;if("A"!==t.nodeName){let n=e.composedPath&&e.composedPath();n||(n=e.path);for(let e=0;e<n.length;e++)if("A"==n[e].nodeName){t=n[e];break}}const n=t.target||t.getAttribute("target");if(!(t.hasAttribute("download")||n&&"_self"!==n)){const n=t.href||t.getAttribute("href");n&&Z.isApplicationLink(n)?(e.preventDefault(),e.stopPropagation(),this.morphUrl(n)):"submit"===t.type&&e.preventDefault()}}async historyHandler(e){await this.getPatchUsingHTTP(location.href);const[t,n]=e.state||[0,0];let o=!1;this._attemptingScroll=!1;const r=()=>o=!this._attemptingScroll;window.addEventListener("scroll",r),await z(30);for(let e=0;e<30&&!o;e++){this._attemptingScroll=!0;const e=(i=t,s=n,scrollTo(i,s),window.scrollX===i&&window.scrollY===s);if(this._attemptingScroll=!1,e)break;await z(30)}var i,s;window.removeEventListener("scroll",r)}stop(){this.unlisten(),super.stop(...arguments)}static isApplicationLink(e){if("string"==typeof e){const t=document.createElement("A");t.href=e,""==t.host&&(t.href=t.href),e=t}return e.protocol==window.location.protocol&&e.host==window.location.host}}e.Palindrom=X,e.PalindromDOM=Z}(this.window=this.window||{},fetch,WebSocket);
