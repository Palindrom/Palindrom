/*! puppet-dom.js version: 1.0.0
 * (c) 2013 Joachim Wester
 * MIT license
 */
!function(a){function b(a,b){for(var c=b;c&&a!==c;)c=c.parentNode||c.host;return a===c}var c=function(a){a||(a={});var b=a.callback;this.element=a.listenTo||document.body;{var c=(this.clickHandler,this.clickHandler.bind(this));this.historyHandler=this.historyHandler.bind(this),this.clickAndBlurCallback=this.clickAndBlurCallback.bind(this)}a.callback=function(a){this.listen(),b&&b.call(this,a)},this.listen=function(){this.listening=!0,this.element.addEventListener("click",c),window.addEventListener("popstate",this.historyHandler),this.element.addEventListener("puppet-redirect-pushstate",this.historyHandler),this.element.addEventListener("blur",this.clickAndBlurCallback,!0),this.addShadowRootClickListeners(c)},this.unlisten=function(){this.listening=!1,this.element.removeEventListener("click",c),window.removeEventListener("popstate",this.historyHandler),this.element.removeEventListener("puppet-redirect-pushstate",this.historyHandler),this.element.removeEventListener("blur",this.clickAndBlurCallback,!0),this.removeShadowRootClickListeners(c)},Puppet.call(this,a)};c.prototype=Object.create(Puppet.prototype),c.prototype.morphUrl=function(a){history.pushState(null,null,a),this.network.changeState(a)},c.prototype.findShadowRoots=function(a,b){b||(b=[]);for(var c=0,d=a.childNodes.length;d>c;c++)if(1===a.childNodes[c].nodeType){var e=a.childNodes[c].shadowRoot||a.childNodes[c].polymerShadowRoot_;e&&(b.push(e),this.findShadowRoots(e,b)),this.findShadowRoots(a.childNodes[c],b)}return b},c.prototype.addShadowRootClickListeners=function(a){for(var c=this.findShadowRoots(this.element),d=0,e=c.length;e>d;d++)(c[d].impl||c[d]).addEventListener("click",a);var f=this,g=Element.prototype.createShadowRoot;Element.prototype.createShadowRoot=function(){var c=g.apply(this,arguments);return f.listening&&b(f.element,unwrap&&unwrap(this)||this)&&c.addEventListener("click",a),c}},c.prototype.removeShadowRootClickListeners=function(a){for(var b=this.findShadowRoots(this.element),c=0,d=b.length;d>c;c++)(b[c].impl||b[c]).removeEventListener("click",a)},c.prototype.clickHandler=function(a){a.detail&&a.detail.target&&(a=a.detail);var b=a.target;if(b.impl&&(b=b.impl),"A"!==b.nodeName){var e=d(b,"A");e&&(b=e)}var f=b.href||b.getAttribute("href");f&&c.isApplicationLink(f)?(a.preventDefault(),a.stopPropagation(),this.morphUrl(f)):"submit"===b.type?a.preventDefault():this.clickAndBlurCallback()},c.prototype.historyHandler=function(){this.network.changeState(location.href)},c.prototype.clickAndBlurCallback=function(a){if(!a||a.target!==document.body&&"BODY"!==a.target.nodeName){var b=jsonpatch.generate(this.observer);b.length&&this.handleLocalChange(b)}},c.isApplicationLink=function(a){if("string"==typeof a){var b=document.createElement("A");b.href=a,""==b.host&&(b.href=b.href),a=b}return a.protocol==window.location.protocol&&a.host==window.location.host};var d=function(a){for(;null!=a;){if(1===a.nodeType&&(a.href||a.getAttribute("href")))return a;a=a.parentNode}return null};a.PuppetDOM=c}(window);