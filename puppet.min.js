/*! puppet.js version: 2.4.0
 * (c) 2013 Joachim Wester
 * MIT license
 */
!function(a){function b(a,b){var c;return c=b?new URL(b,window.location):new URL(window.location.href),c.protocol="https:"===c.protocol?"wss:":"ws:",Object.defineProperty(a,"wsURL",{value:c})}function c(a,b,c){function d(){e=i,f=0,g=!1,clearTimeout(h),h=null}var e,f,g,h,i=1e3,j=function(){0==f?(b(0),g=!1,e*=2,a()):(b(f),f-=1e3,setTimeout(j,1e3))};this.triggerReconnection=function(){g||(f=e,g=!0,j())},this.reconnectNow=function(){f=0,e=i},this.stopReconnecting=function(){d(),c()},d()}function d(a,b,c,d){var e,f;this.start=function(){e||(e=setTimeout(function(){this.notifySend(),a()}.bind(this),c))},this.notifySend=function(){clearTimeout(e),e=null,f||(f=setTimeout(function(){f=null,b()}.bind(this),d))},this.notifyReceive=function(){clearTimeout(f),f=null,this.start()},this.stop=function(){clearTimeout(e),e=null,clearTimeout(f),f=null}}function e(){this.start=this.stop=this.notifySend=this.notifyReceive=function(){}}function f(a,c,d,e,f,g,h,i){this.puppet=a,c instanceof URL?this.remoteUrl=c:c?this.remoteUrl=new URL(c,window.location.href):this.remoteUrl=new URL(window.location.href),d&&b(this,c),e&&(this.onReceive=e),f&&(this.onSend=f),g&&(this.onConnectionError=g),h&&(this.onFatalError=h),i&&(this.onStateChange=i);var j=this;Object.defineProperty(this,"useWebSocket",{get:function(){return d},set:function(a){return d=a,0==a?j._ws&&(j._ws.onclose=function(){j._ws=null},j._ws.close()):j.wsURL||b(this,c),d}})}function g(a,b,c,d){return a.xhr(b,"application/json",c,function(b){d(b.responseText),a.useWebSocket&&a.webSocketUpgrade()})}function h(a){a._ws&&(a._ws.onclose=function(){},a._ws.close(),a._ws=null)}function i(a){this.apply=a}function j(a,b){a.heartbeat.stop(),b(function(b){var c=JSON.parse(b);a.reconnector.stopReconnecting(),a.queue.reset(a.obj,c),a.debug&&(a.remoteObj=b),a.observe(),a.onDataReady&&a.onDataReady.call(a,a.obj),a.heartbeat.start()})}function k(a){j(a,a.network.establish.bind(a.network))}function l(a){j(a,function(b){a.network.reestablish(a.queue.pending,b)})}function m(a){if(a||(a={}),this.jsonpatch=a.jsonpatch||this.jsonpatch,this.debug=void 0==a.debug||a.debug,"obj"in a){if("object"!=typeof a.obj)throw new Error("'options.obj' is not an object");this.obj=a.obj}else this.obj={};var b=function(){};if(this.observer=null,this.onLocalChange=a.onLocalChange,this.onRemoteChange=a.onRemoteChange,this.onPatchReceived=a.onPatchReceived||b,this.onPatchSent=a.onPatchSent||b,this.onSocketStateChanged=a.onSocketStateChanged||b,this.onConnectionError=a.onConnectionError||b,this.retransmissionThreshold=a.retransmissionThreshold||3,this.onReconnectionCountdown=a.onReconnectionCountdown||b,this.onReconnectionEnd=a.onReconnectionEnd||b,this.reconnector=new c(function(){l(this)}.bind(this),this.onReconnectionCountdown,this.onReconnectionEnd),a.pingIntervalS){const g=1e3*a.pingIntervalS;this.heartbeat=new d(this.ping.bind(this),this.handleConnectionError.bind(this),g,g)}else this.heartbeat=new e;this.network=new f(this,a.remoteUrl,a.useWebSocket||!1,this.handleRemoteChange.bind(this),this.onPatchSent.bind(this),this.handleConnectionError.bind(this),this.handleFatalError.bind(this),this.onSocketStateChanged.bind(this)),Object.defineProperty(this,"useWebSocket",{get:function(){return this.network.useWebSocket},set:function(a){this.network.useWebSocket=a}}),this.ignoreCache={},this.ignoreAdd=a.ignoreAdd||null,this.onDataReady=a.callback,a.localVersionPath?a.remoteVersionPath?this.queue=a.ot?new JSONPatchOTAgent(JSONPatchOT.transform,[a.localVersionPath,a.remoteVersionPath],this.validateAndApplySequence.bind(this),a.purity):new JSONPatchQueue([a.localVersionPath,a.remoteVersionPath],this.validateAndApplySequence.bind(this),a.purity):this.queue=new JSONPatchQueueSynchronous(a.localVersionPath,this.validateAndApplySequence.bind(this),a.purity):this.queue=new i(this.validateAndApplySequence.bind(this)),k(this)}function n(a,b,c,d){if("add"===d&&a.test(c))return b[c]=!0,!0;for(var e=c.split("/"),f="",g=1,h=e.length;g<h;g++)if(f+="/"+e[g],b[f])return!0;return!1}function o(a,b){var c=JSON.stringify(b);a.unobserve(),a.heartbeat.notifySend(),a.network.send(c),a.observe()}var p=function(){};p.prototype={constructor:p,apply:function(a){a.addEventListener=p.prototype.addEventListener,a.hasEventListener=p.prototype.hasEventListener,a.removeEventListener=p.prototype.removeEventListener,a.dispatchEvent=p.prototype.dispatchEvent},addEventListener:function(a,b){void 0===this._listeners&&(this._listeners={});var c=this._listeners;void 0===c[a]&&(c[a]=[]),c[a].indexOf(b)===-1&&c[a].push(b)},hasEventListener:function(a,b){if(void 0===this._listeners)return!1;var c=this._listeners;return void 0!==c[a]&&c[a].indexOf(b)!==-1},removeEventListener:function(a,b){if(void 0!==this._listeners){var c=this._listeners,d=c[a];if(void 0!==d){var e=d.indexOf(b);e!==-1&&d.splice(e,1)}}},dispatchEvent:function(a){if(void 0!==this._listeners){var b=this._listeners,c=b[a.type];if(void 0!==c){a.target=this;for(var d=[],e=c.length,f=0;f<e;f++)d[f]=c[f];for(var f=0;f<e;f++)d[f].call(this,a)}}}},f.prototype.establish=function(a){g(this,this.remoteUrl.href,null,a)},f.prototype.reestablish=function(a,b){g(this,this.remoteUrl.href+"/reconnect",JSON.stringify(a),b)},f.prototype.send=function(a){var b=this;if(this.useWebSocket&&this._ws&&1===this._ws.readyState)this._ws.send(a),b.onSend(a,b._ws.url,"WS");else{var c=this.remoteUrl.href;this.xhr(c,"application/json-patch+json",a,function(a,d){b.onReceive(a.responseText,c,d)})}return this},f.prototype.onReceive=function(){},f.prototype.onSend=function(){},f.prototype.onStateChange=function(){},f.prototype.upgrade=function(a){},f.prototype.webSocketUpgrade=function(a){var b=this,c=new URL(this.remoteUrl.pathname,this.wsURL).href;h(b),b._ws=new WebSocket(c),b._ws.onopen=function(d){b.onStateChange(b._ws.readyState,c),a&&a(d)},b._ws.onmessage=function(a){b.onReceive(a.data,b._ws.url,"WS")},b._ws.onerror=function(a){if(b.onStateChange(b._ws.readyState,c,a.data),b.useWebSocket){var d={statusText:"WebSocket connection could not be made.",readyState:b._ws.readyState,url:c};b.onFatalError(d,c,"WS")}},b._ws.onclose=function(a){b.onStateChange(b._ws.readyState,c,null,a.code,a.reason);var d={statusText:"WebSocket connection closed.",readyState:b._ws.readyState,url:c,statusCode:a.code,reason:a.reason};a.reason?b.onFatalError(d,c,"WS"):b.onConnectionError()}},f.prototype.changeState=function(a){var b=this;return this.xhr(a,"application/json-patch+json",null,function(c,d){b.onReceive(c.responseText,a,d)},!0)},f.prototype.setRemoteUrl=function(a){if(this.remoteUrlSet&&this.remoteUrl&&this.remoteUrl.href!=a)throw new Error("Session lost. Server replied with a different session ID that was already set. \nPossibly a server restart happened while you were working. \nPlease reload the page.\n\nPrevious session ID: "+this.remoteUrl+"\nNew session ID: "+a);this.remoteUrlSet=!0,this.remoteUrl=new URL(a,this.remoteUrl.href)},f.prototype.handleResponseHeader=function(a){var b=a.getResponseHeader("X-Location")||a.getResponseHeader("Location");b&&this.setRemoteUrl(b)},f.prototype.xhr=function(a,b,c,d,e){var f=this,g=new XMLHttpRequest,h="GET";return g.onload=function(){var b=this;f.handleResponseHeader(b),b.status>=400&&b.status<=599?f.onFatalError({statusCode:b.status,statusText:b.statusText,reason:b.responseText},a,h):d&&d.call(f.puppet,b,h)},g.onerror=f.onConnectionError.bind(f),a=a||window.location.href,c?(h="PATCH",g.open(h,a,!0),g.setRequestHeader("Content-Type","application/json-patch+json")):g.open(h,a,!0),b&&g.setRequestHeader("Accept",b),f.remoteUrl&&e&&g.setRequestHeader("X-Referer",f.remoteUrl.pathname),f.onSend(c,a,h),g.send(c),g},i.prototype.send=function(a){return a},i.prototype.receive=function(a,b){this.apply(a,b)},i.prototype.reset=function(a,b){var c=[{op:"replace",path:"",value:b}];this.apply(a,c)},m.prototype=Object.create(p.prototype);var q=function(a,b){var c;if(ErrorEvent.prototype.initErrorEvent){var d=document.createEvent("ErrorEvent");d.initErrorEvent("error",!0,!0,b.message,"",""),Object.defineProperty(d,"error",{value:b})}else c=new ErrorEvent("error",{bubbles:!0,cancelable:!0,error:b});a.dispatchEvent(c)};m.prototype.jsonpatch=a.jsonpatch,m.prototype.ping=function(){o(this,[])},m.prototype.observe=function(){this.observer=this.jsonpatch.observe(this.obj,this.filterChangedCallback.bind(this))},m.prototype.unobserve=function(){this.observer&&(this.jsonpatch.unobserve(this.obj,this.observer),this.observer=null)},m.prototype.filterChangedCallback=function(a){this.filterIgnoredPatches(a),a.length&&this.handleLocalChange(a)},m.prototype.filterIgnoredPatches=function(a){if(this.ignoreAdd)for(var b=0,c=a.length;b<c;b++)n(this.ignoreAdd,this.ignoreCache,a[b].path,a[b].op)&&(a.splice(b,1),c--,b--);return a},m.prototype.handleLocalChange=function(a){this.debug&&this.validateSequence(this.remoteObj,a),o(this,this.queue.send(a)),this.onLocalChange&&this.onLocalChange(a)},m.prototype.validateAndApplySequence=function(a,b){this.unobserve();try{var c=this.jsonpatch.apply(a,b,this.debug)}catch(a){if(this.debug)return a.message="Incoming patch validation error: "+a.message,void q(this,a);throw a}var d=this;b.forEach(function(a){if(""===a.path){var c=JSON.stringify(b);c.length>103&&(c=c.substring(0,100)+"..."),d.showWarning("Server pushed patch that replaces the object root",c)}}),this.observe(),this.onRemoteChange&&(console.warn("PuppetJs.onRemoteChange is deprecated, please use patch-applied event instead."),this.onRemoteChange(b,c)),this.dispatchEvent(new CustomEvent("patch-applied",{bubbles:!0,cancelable:!0,detail:{patches:b,results:c}}))},m.prototype.validateSequence=function(a,b){var c=this.jsonpatch.validate(b,a);c&&(c.message="Outgoing patch validation error: "+c.message,q(this,c))},m.prototype.handleConnectionError=function(){this.heartbeat.stop(),this.reconnector.triggerReconnection()},m.prototype.handleFatalError=function(a,b,c){this.heartbeat.stop(),this.reconnector.stopReconnecting(),this.onConnectionError&&this.onConnectionError(a,b,c)},m.prototype.reconnectNow=function(){this.reconnector.reconnectNow()},m.prototype.showWarning=function(b,c){this.debug&&a.console&&console.warn&&(c&&(b+=" ("+c+")"),console.warn("PuppetJs warning: "+b))},m.prototype.handleRemoteChange=function(a,b,c){this.heartbeat.notifyReceive();var d=JSON.parse(a||"[]");0!==d.length&&(this.onPatchReceived&&this.onPatchReceived(a,b,c),this.observer&&(this.queue.receive(this.obj,d),this.queue.pending&&this.queue.pending.length&&this.queue.pending.length>this.retransmissionThreshold&&this.queue.pending.forEach(o.bind(null,this)),this.debug&&(this.remoteObj=JSON.parse(JSON.stringify(this.obj)))))},a.Puppet=m}(window);